<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delphis – Marine Mammal Sightings Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Optional: marker clustering (recommended if you have hundreds/thousands) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- CSV parser (PapaParse) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, Arial; }
    #wrap { display:grid; grid-template-columns: 360px 1fr; height:100vh; }
    #panel { padding:14px; border-inline-end:1px solid #e5e5e5; overflow:auto; }
    #map { height:100vh; }
    label { display:block; margin-top:10px; font-weight:600; }
    input, select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .muted { color:#666; font-size: 13px; margin-top: 8px; }
    .badge { display:inline-block; padding:2px 8px; border-radius: 999px; font-size: 12px; border:1px solid #ddd; margin: 4px 6px 0 0; }
    button { margin-top:12px; padding:10px; width:100%; cursor:pointer; }
  </style>
</head>

<body>
<div id="wrap">
  <div id="panel">
    <h2 style="margin:0 0 6px 0;">תצפיות יונקים ימיים</h2>
    <div class="muted">נתונים נטענים מהגיליון (מתעדכן אוטומטית).</div>

    <label>מין</label>
    <select id="speciesSelect">
      <option value="">כל המינים</option>
    </select>

    <div class="row">
      <div>
        <label>מתאריך</label>
        <input id="fromDate" type="date" />
      </div>
      <div>
        <label>עד תאריך</label>
        <input id="toDate" type="date" />
      </div>
    </div>

    <label>חיפוש / אזור תצפית</label>
    <input id="regionSearch" type="text" placeholder="למשל: אשדוד / תל אביב / Akhziv..." />
    <button id="resetBtn" type="button">איפוס סינון</button>

    <div class="muted" id="stats"></div>
    <div id="legend" style="margin-top:10px;"></div>
  </div>

  <div id="map"></div>
</div>

<script>
/** =========================
 *  CONFIG – התאימי לשמות העמודות בגיליון
 *  ========================= */
const CONFIG = {
  // Published sheet key (כפי שיש אצלך)
  sheetKey: "2PACX-1vScGQMGuLY1A7XVcfAObxaE94n_zKVU1zsMsY3MUSD2LmWXAuLBecvLbgZ5ffXsKLVyCx3RdUIRSKx7",

  // CSV publish endpoint (הכי יציב ל-GitHub Pages)
  // אם בעתיד תגלי שאת חייבת gid לטאב אחר, נוסיף &gid=XXXX
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vScGQMGuLY1A7XVcfAObxaE94n_zKVU1zsMsY3MUSD2LmWXAuLBecvLbgZ5ffXsKLVyCx3RdUIRSKx7/pub?output=csv",

  // שמות עמודות – התאימי לפי הכותרות האמיתיות בגיליון
  cols: {
    lat: "Latitude",
    lon: "Longitude",
    posEstimate: "Position estimate",
    speciesHe: "Species (HE)",
    speciesEn: "Species (EN)",
    date: "Date",
    count: "Individuals",
    calves: "Calves",
    details: "Details",
    region: "Area"
  },

  estimateLookup: {
    "Ashdod": [31.8044, 34.6553],
    "Tel Aviv": [32.0853, 34.7818],
    "Akhziv": [33.0489, 35.1048]
  }
};

/** =========================
 *  Helpers
 *  ========================= */
function formatDDMMYYYY(d) {
  if (!d) return "";
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

function parseDate(value) {
  if (!value) return null;
  const s = String(value).trim();
  const m1 = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (m1) return new Date(Number(m1[3]), Number(m1[2])-1, Number(m1[1]));
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m2) return new Date(Number(m2[1]), Number(m2[2])-1, Number(m2[3]));
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

function tryParseLatLon(text) {
  if (!text) return null;
  const m = String(text).match(/(-?\d{1,2}\.\d+)\s*,\s*(-?\d{1,3}\.\d+)/);
  if (!m) return null;
  return [Number(m[1]), Number(m[2])];
}

function norm(s){ return (s ?? "").toString().trim(); }

/** =========================
 *  Fetch from Google Sheets (CSV)
 *  ========================= */
async function fetchSheetRowsCSV() {
  const res = await fetch(CONFIG.csvUrl, { cache: "no-store" });
  if (!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);

  const csvText = await res.text();
  const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });

  if (parsed.errors && parsed.errors.length) {
    console.warn("CSV parse errors:", parsed.errors);
  }
  return parsed.data; // array of objects, keys = headers
}

/** =========================
 *  Map setup
 *  ========================= */
const map = L.map('map').setView([32.4, 34.9], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

const cluster = L.markerClusterGroup();
map.addLayer(cluster);

let allData = [];
let markers = [];
let speciesColors = new Map();

function colorForSpecies(key) {
  if (!speciesColors.has(key)) {
    const palette = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
    speciesColors.set(key, palette[speciesColors.size % palette.length]);
  }
  return speciesColors.get(key);
}

function makeMarkerIcon(color) {
  return L.divIcon({
    className: "",
    html: `<div style="
      width:14px;height:14px;border-radius:50%;
      background:${color};border:2px solid white;
      box-shadow:0 0 0 1px rgba(0,0,0,.25);
    "></div>`,
    iconSize: [14,14],
    iconAnchor: [7,7]
  });
}

function buildPopup(item) {
  const he = norm(item[CONFIG.cols.speciesHe]);
  const en = norm(item[CONFIG.cols.speciesEn]);
  const date = formatDDMMYYYY(parseDate(item[CONFIG.cols.date]));
  const count = norm(item[CONFIG.cols.count]);
  const calves = norm(item[CONFIG.cols.calves]);
  const details = norm(item[CONFIG.cols.details]);
  const region = norm(item[CONFIG.cols.region]) || norm(item[CONFIG.cols.posEstimate]);

  return `
    <div dir="rtl" style="min-width:240px">
      <div style="font-weight:800">${he}${en ? ` / <span dir="ltr">${en}</span>` : ""}</div>
      <div><b>מועד:</b> ${date || "—"}</div>
      <div><b>כמות פרטים:</b> ${count || "—"}</div>
      <div><b>גורים:</b> ${calves || "—"}</div>
      <div><b>אזור:</b> ${region || "—"}</div>
      ${details ? `<div style="margin-top:6px"><b>פירוט:</b> ${details}</div>` : ""}
    </div>
  `;
}

function getLatLon(item) {
  const lat = Number(item[CONFIG.cols.lat]);
  const lon = Number(item[CONFIG.cols.lon]);
  if (!isNaN(lat) && !isNaN(lon) && Math.abs(lat) > 0 && Math.abs(lon) > 0) return [lat, lon];

  const est = norm(item[CONFIG.cols.posEstimate]);
  const parsed = tryParseLatLon(est);
  if (parsed) return parsed;

  if (CONFIG.estimateLookup[est]) return CONFIG.estimateLookup[est];

  return null;
}

function render(data) {
  cluster.clearLayers();
  markers = [];

  const sel = document.getElementById("speciesSelect");
  const current = sel.value;

  const speciesSet = new Set(
    data.map(d => `${norm(d[CONFIG.cols.speciesHe])}||${norm(d[CONFIG.cols.speciesEn])}`)
       .filter(k => k !== "||")
  );

  sel.innerHTML = `<option value="">כל המינים</option>`;
  [...speciesSet].sort().forEach(k => {
    const [he,en] = k.split("||");
    const label = `${he}${en ? ` / ${en}` : ""}`;
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = label;
    sel.appendChild(opt);
  });
  sel.value = current;

  const legend = document.getElementById("legend");
  legend.innerHTML = "";
  [...speciesSet].slice(0,12).forEach(k => {
    const [he,en] = k.split("||");
    const label = `${he}${en ? ` / ${en}` : ""}`;
    const c = colorForSpecies(k);
    const span = document.createElement("span");
    span.className = "badge";
    span.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${c};margin-inline-end:6px;vertical-align:middle"></span>${label}`;
    legend.appendChild(span);
  });

  let shown = 0;
  for (const item of data) {
    const ll = getLatLon(item);
    if (!ll) continue;

    const key = `${norm(item[CONFIG.cols.speciesHe])}||${norm(item[CONFIG.cols.speciesEn])}`;
    const icon = makeMarkerIcon(colorForSpecies(key));

    const m = L.marker(ll, { icon });
    m.bindPopup(buildPopup(item));
    cluster.addLayer(m);
    markers.push(m);
    shown++;
  }

  document.getElementById("stats").textContent =
    `מוצגות ${shown} תצפיות (מתוך ${data.length} שורות נתונים).`;
}

function applyFilters() {
  const speciesVal = document.getElementById("speciesSelect").value;
  const q = norm(document.getElementById("regionSearch").value).toLowerCase();
  const from = document.getElementById("fromDate").value ? new Date(document.getElementById("fromDate").value) : null;
  const to = document.getElementById("toDate").value ? new Date(document.getElementById("toDate").value) : null;

  const filtered = allData.filter(item => {
    const key = `${norm(item[CONFIG.cols.speciesHe])}||${norm(item[CONFIG.cols.speciesEn])}`;
    if (speciesVal && key !== speciesVal) return false;

    const d = parseDate(item[CONFIG.cols.date]);
    if (from && d && d < from) return false;
    if (to && d && d > to) return false;

    if (q) {
      const region = (norm(item[CONFIG.cols.region]) || "") + " " + (norm(item[CONFIG.cols.posEstimate]) || "");
      const sp = norm(item[CONFIG.cols.speciesHe]) + " " + norm(item[CONFIG.cols.speciesEn]);
      const hay = (region + " " + sp).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  render(filtered);
}

document.getElementById("speciesSelect").addEventListener("change", applyFilters);
document.getElementById("regionSearch").addEventListener("input", () => { clearTimeout(window.__t); window.__t=setTimeout(applyFilters, 200); });
document.getElementById("fromDate").addEventListener("change", applyFilters);
document.getElementById("toDate").addEventListener("change", applyFilters);

document.getElementById("resetBtn").addEventListener("click", () => {
  document.getElementById("speciesSelect").value = "";
  document.getElementById("regionSearch").value = "";
  document.getElementById("fromDate").value = "";
  document.getElementById("toDate").value = "";
  applyFilters();
});

(async function init(){
  try {
    allData = await fetchSheetRowsCSV();
    render(allData);
  } catch (e) {
    console.error(e);
    document.getElementById("stats").textContent =
      "שגיאה בטעינת נתונים מהגיליון. בדקי Console (F12).";
  }
})();
</script>
</body>
</html>
